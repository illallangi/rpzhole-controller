#!/usr/bin/env sh

export UMASK_SET=${UMASK_SET:-022}
export PUID=${PUID:-1000}
export PGID=${PGID:-1000}
export HOSTS_URI=${HOSTS_URI:-https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts}

umask "$UMASK_SET" || exit 1

if [[ $( id -u ) -eq 0 ]]; then

  mkdir -p /zones || exit 1
  generate-zonefile $HOSTS_URI > /zones/db.hole.rpz || exit 1

  addgroup -g ${PGID} abc || exit 1
  adduser -G abc -D -H -u ${PUID} abc || exit 1
  chown abc.abc /zones/db.hole.rpz
  chmod 0644 /zones/db.hole.rpz

  gosu abc $0 $* || exit 1

else

  if [ -z "${INTERVAL}" ]; then

    exec $@

  else
    
    >&2 echo Generated initial zone file
    >&2 md5sum /zones/db.hole.rpz


    while :; do

      >&2 echo Sleeping ${INTERVAL}
      sleep ${INTERVAL}
      >&2 echo Updating zone file
      generate-zonefile $HOSTS_URI > /zones/db.hole.rpz || exit 1
      >&2 md5sum /zones/db.hole.rpz

    done

  fi

fi